<section id="challenges-show">
  <div class="challenge-header text-center mt-3">
      <h2 class="text-center mt-2">
        <%= @challenge.name %>
      </h2>
    <div class="divider"></div>

    <div class="text-center fs-4">
      <%= @challenge.created_at.strftime('%d-%m-%Y') %> /
      <%= @challenge.deadline.strftime('%d-%m-%Y') %>
      <% if days_left(@challenge) == 0 %>
        (<%= t('challenge_end').downcase %>)
      <% else %>
        (<%= t('days_left', count: days_left(@challenge)).downcase %>)
      <% end %>
    </div>

    <div class="mt-1 d-flex justify-content-around">
      <div>
        <%= link_to t('invite_user'), create_invitation_challenge_path(@challenge),
                    class: 'btn btn-sm btn-primary' if @challenge.check_creator(current_user) %>
        <%= link_to t('add_goal'), add_goal_challenge_path(@challenge),
                    class: 'btn btn-sm btn-primary mx-3' %>
      </div>

      <div>
        <%= link_to t('leave_challenge'), leave_challenge_path(@challenge),
                    data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' },
                    class: 'btn btn-sm btn-warning' %>
      </div>
    </div>

    <div class="winner-board">
      <div class="card">
        <div class="card-body">
          <div class="fs-4 fw-medium text-uppercase">
            <%= t('winners') %>
          </div>

          <% winners = winners_of(@challenge) %>
          <div class="winner-board__user d-flex justify-content-between">
            <% if winners.present? %>
              <% winners.each do |winner, tasks| %>
                <div class="mx-2 mt-2">
                  <%= user_avatar(winner, size: 60, style: "border: 5px solid #{load_level_color(tasks)};") %>
                  <span class="fw-medium d-block"><%= winner.name %></span>
                </div>
              <% end %>
            <% else %>
              <%= inline_svg_tag("icons/basic/question", options = { height: 60, width: 60, class: 'question mt-2' }) %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div>
      <%= link_to t('my_goals'), challenge_path(@challenge, filter: "#{current_user.id}"),
                  class: "#{params[:filter] == "#{current_user.id}" ?
                              'btn btn-primary btn-sm' :
                              'btn btn-outline-primary btn-sm'}" %>
      <%= link_to t('all_goals'), challenge_path(@challenge),
                  class: "#{params[:filter].nil? ?
                              'btn btn-primary btn-sm' :
                              'btn btn-outline-primary btn-sm'}" %>

      <a class="btn btn-sm btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample">
        <%= t('rating') %>
      </a>
    </div>
  </div>

  <div class="challenge-wrapper mt-3">
    <ul class="goal-items">

      <% if @challenge_goals.present? %>
        <% @challenge_goals.each_with_index do |goal, index| %>

          <li class="goal-item" style="border-top: 7px solid <%= load_level_color(goal.tasks) %>">
            <% percentage = calculate_items(goal: goal, user: goal.user) %>
            <%= button_to '', destroy_goal_challenge_path(@challenge, goal_id: goal.id),
                          method: :delete, form: { data: { 'turbo-confirm': 'Are you sure?' } },
                          class: 'btn-close position-absolute' if goal.user == current_user %>

            <div class="goal-item__progress fw-bold fs-4" style="background:
              radial-gradient(closest-side, white 79%, transparent 80%),
                conic-gradient(rgba(9, 194, 30, 1) <%= percentage %>%, rgba(39, 245, 63, 0.21) 0%);">
              <span><%= percentage %>%</span></div>
            <div class="goal-item__user text-center mt-1 fw-medium"><%= goal.user.name %></div>

            <div class="goal-item__tasks text-center mt-1">
              <% if goal.user == current_user %>
                <%= link_to t('target', count: goal.tasks.count), goal, class: 'link-offset-2 link-underline' %>
              <% else %>
                <%= t('target', count: goal.tasks.count) %>
              <% end %>
            </div>

            <div class="bottom-wrapper">
              <div class="bottom-wrapper__user-photo"><%= user_avatar(goal.user) %></div>
              <div class="bottom-wrapper__created-ago fst-italic">
                <%= time_ago_in_words(goal.created_at) %>
                <%= t('ago') %>
              </div>
            </div>
          </li>
        <% end %>

      <% else %>
        <div class="text-center fs-2">No goals</div>
      <% end %>
    </ul>
  </div>
</section>


<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasExampleLabel"><%= t('challenge_users') %></h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body">
    <div class="table-body">
      <table class="table table-hover">
        <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col"><%= t('member') %></th>
          <th scope="col"><%= t('name') %></th>
          <th scope="col"><%= t('targets') %></th>
          <th scope="col"><%= t('load') %></th>
        </tr>
        </thead>
        <tbody class="overflow-y-auto">
        <% @members.each_with_index do |user, index| %>
          <% user_goal = user.user_goal_in(@challenge)&.tasks&.count %>

          <tr>
            <th scope="row"><%= index + 1 %></th>
            <td><%= user_avatar(user, size: 25) %></td>
            <td><%= user.name %></td>
            <td><%= user_goal.present? ? user_goal : 0 %></td>
            <td class="fs-4">
              <i class="bi bi-minecart-loaded" style="color: <%= load_level_color(user_goal)  %>"></i>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>




